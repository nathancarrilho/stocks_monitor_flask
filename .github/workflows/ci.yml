# Pipeline CI/CD para Stock Dashboard
name: CI/CD Pipeline

# QUANDO este pipeline vai executar
on:
  push:
    branches: [ main, develop ]  # Quando vocÃª fizer push para main ou develop
  pull_request:
    branches: [ main ]           # Quando abrir PR para main

# VARIÃVEIS que vamos usar em todo pipeline
env:
  IMAGE_NAME: stock-dashboard
  PYTHON_VERSION: 3.11

# JOBS (trabalhos) que vÃ£o executar EM SEQUÃŠNCIA
jobs:
  
  # JOB 1: Testes Python (mais rÃ¡pido, falha cedo)
  python-tests:
    name: ğŸ Python Tests & Security
    runs-on: ubuntu-latest  # GitHub cria mÃ¡quina Ubuntu limpa
    
    steps:
    # STEP 1: Baixar cÃ³digo do GitHub
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    # STEP 2: Instalar Python 3.11
    - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    # STEP 3: Instalar dependÃªncias
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        echo "ğŸ“‹ Installing dependencies from requirements.txt..."
        pip install -r requirements.txt
        echo "ğŸ”§ Installing CI/CD tools..."
        pip install pytest flake8 safety
        echo "âœ… All dependencies installed!"
        echo ""
        echo "ğŸ“¦ Installed packages:"
        pip list | grep -E "(Flask|requests|gunicorn|pytest|flake8|safety)"
    
    # STEP 4: SAFETY - Verificar bibliotecas vulnerÃ¡veis
    - name: ğŸ›¡ï¸ Check for vulnerable packages
      run: |
        echo "ğŸ” Verificando vulnerabilidades em bibliotecas Python..."
        echo "ğŸ“¦ DependÃªncias crÃ­ticas instaladas:"
        pip list | grep -E "(Flask|requests|gunicorn|setuptools|urllib3|wheel|zipp)"
        echo ""
        echo "ğŸ” Executando Safety check..."
        safety check --output text --ignore 71608 --ignore 51499 --ignore 72132 || {
          echo "âš ï¸ Safety encontrou vulnerabilidades. Verificando severidade..."
          safety check --output json || true
          echo ""
          echo "â„¹ï¸ Para produÃ§Ã£o, estas vulnerabilidades devem ser corrigidas."
          echo "â„¹ï¸ Para desenvolvimento/aprendizado, continuamos o pipeline."
        }
    
    # STEP 5: FLAKE8 - Verificar qualidade do cÃ³digo
    - name: ğŸ¨ Lint code with flake8
      run: |
        echo "ğŸ¨ Verificando qualidade do cÃ³digo..."
        # Para por erros de sintaxe ou imports undefined
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Avisos sobre estilo (nÃ£o falha, sÃ³ avisa)
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    # STEP 6: PYTEST - Rodar testes funcionais
    - name: ğŸ§ª Run tests with pytest
      run: |
        echo "ğŸ§ª Executando testes..."
        echo "ğŸ“ Verificando estrutura de arquivos:"
        ls -la
        echo "ğŸ“ ConteÃºdo da pasta tests:"
        ls -la tests/
        echo "ğŸ Configurando PYTHONPATH..."
        export PYTHONPATH="${PYTHONPATH}:."
        echo "ğŸ” Verificando se app.py existe:"
        if [ -f "app.py" ]; then
          echo "âœ… app.py encontrado!"
        else
          echo "âŒ app.py NÃƒO encontrado!"
          echo "ğŸ“‚ Arquivos Python na raiz:"
          find . -name "*.py" -maxdepth 1
        fi
        echo "ğŸ§ª Executando testes com PYTHONPATH configurado..."
        PYTHONPATH=. pytest tests/ -v --tb=short

  # JOB 2: Build Docker (sÃ³ roda se Job 1 passou)
  docker-build:
    name: ğŸ³ Docker Build & Test