# Pipeline CI/CD para Stock Dashboard
name: CI/CD Pipeline

# QUANDO este pipeline vai executar
on:
  push:
    branches: [ main, develop ]  # Quando vocÃª fizer push para main ou develop
  pull_request:
    branches: [ main ]           # Quando abrir PR para main

# VARIÃVEIS que vamos usar em todo pipeline
env:
  IMAGE_NAME: stock-dashboard
  PYTHON_VERSION: 3.11

# JOBS (trabalhos) que vÃ£o executar EM SEQUÃŠNCIA
jobs:
  
  # JOB 1: Testes Python (mais rÃ¡pido, falha cedo)
  python-tests:
    name: ðŸ Python Tests & Security
    runs-on: ubuntu-latest  # GitHub cria mÃ¡quina Ubuntu limpa
    
    steps:
    # STEP 1: Baixar cÃ³digo do GitHub
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    # STEP 2: Instalar Python 3.11
    - name: ðŸ Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    # STEP 3: Instalar dependÃªncias
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # Ferramentas extras para CI
        pip install pytest flake8 safety
    
    # STEP 4: SAFETY - Verificar bibliotecas vulnerÃ¡veis
    - name: ðŸ›¡ï¸ Check for vulnerable packages
      run: |
        echo "ðŸ” Verificando vulnerabilidades em bibliotecas Python..."
        safety check --json || safety check
        # Se encontrar vulnerabilidade crÃ­tica, falha aqui
    
    # STEP 5: FLAKE8 - Verificar qualidade do cÃ³digo
    - name: ðŸŽ¨ Lint code with flake8
      run: |
        echo "ðŸŽ¨ Verificando qualidade do cÃ³digo..."
        # Para por erros de sintaxe ou imports undefined
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Avisos sobre estilo (nÃ£o falha, sÃ³ avisa)
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    # STEP 6: PYTEST - Rodar testes funcionais
    - name: ðŸ§ª Run tests with pytest
      run: |
        echo "ðŸ§ª Executando testes..."
        pytest tests/ -v --tb=short
        # -v = verbose (mostra detalhes)
        # --tb=short = traceback curto se falhar

  # JOB 2: Build Docker (sÃ³ roda se Job 1 passou)
  docker-build:
    name: ðŸ³ Docker Build & Test
    runs-on: ubuntu-latest
    needs: python-tests  # DEPENDÃŠNCIA: sÃ³ roda se python-tests passou
    
    steps:
    # STEP 1: Baixar cÃ³digo (job novo = mÃ¡quina limpa)
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    # STEP 2: Configurar Docker Buildx (versÃ£o avanÃ§ada do docker build)
    - name: ðŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    # STEP 3: Build da imagem Docker
    - name: ðŸ³ Build Docker image
      run: |
        echo "ðŸ—ï¸ Construindo imagem Docker..."
        docker build -t ${{ env.IMAGE_NAME }}:latest .
        docker build -t ${{ env.IMAGE_NAME }}:${{ github.sha }} .
        # Cria 2 tags: :latest e :commit-hash
        echo "âœ… Imagem construÃ­da com sucesso!"
    
    # STEP 4: Testar se container funciona
    - name: ðŸ§ª Test container functionality
      run: |
        echo "ðŸ§ª Testando se container funciona..."
        
        # Roda container em background
        docker run -d --name test-container -p 5000:5000 ${{ env.IMAGE_NAME }}:latest
        
        # Aguarda aplicaÃ§Ã£o subir (importante!)
        echo "â³ Aguardando aplicaÃ§Ã£o inicializar..."
        sleep 15
        
        # Testa se API responde
        echo "ðŸ” Testando API..."
        curl -f http://localhost:5000/api/test || {
          echo "âŒ API nÃ£o estÃ¡ respondendo!"
          docker logs test-container
          exit 1
        }
        
        echo "âœ… Container funcionando corretamente!"
        
        # Limpa container
        docker stop test-container
        docker rm test-container

  # JOB 3: Security Scan (sÃ³ roda se Job 2 passou)
  security-scan:
    name: ðŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    needs: docker-build  # DEPENDÃŠNCIA: sÃ³ roda se docker-build passou
    
    steps:
    # STEP 1: Baixar cÃ³digo
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    # STEP 2: Build imagem novamente (job novo = mÃ¡quina limpa)
    - name: ðŸ³ Rebuild image for scanning
      run: |
        docker build -t ${{ env.IMAGE_NAME }}:scan .
    
    # STEP 3: TRIVY - Scan completo da imagem
    - name: ðŸ” Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: '${{ env.IMAGE_NAME }}:scan'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'  # SÃ³ falha em vulnerabilidades crÃ­ticas/altas
    
    # STEP 4: Upload resultados (para ver no GitHub)
    - name: ðŸ“Š Upload Trivy scan results to GitHub Security
      uses: github/codeql-action/upload-sarif@v2
      if: always()  # Executa mesmo se step anterior falhar
      with:
        sarif_file: 'trivy-results.sarif'
    
    # STEP 5: Scan simples com output no terminal
    - name: ðŸ›¡ï¸ Run Trivy scan (terminal output)
      run: |
        echo "ðŸ” Executando scan de seguranÃ§a..."
        docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
          aquasec/trivy:latest image --exit-code 1 --severity HIGH,CRITICAL \
          ${{ env.IMAGE_NAME }}:scan
        # exit-code 1 = falha pipeline se encontrar vulnerabilidade HIGH/CRITICAL

  # JOB 4: RelatÃ³rio final
  report:
    name: ðŸ“‹ Pipeline Report
    runs-on: ubuntu-latest
    needs: [python-tests, docker-build, security-scan]
    if: always()  # Executa SEMPRE (mesmo se outros jobs falharam)
    
    steps:
    - name: ðŸ“Š Generate Pipeline Summary
      run: |
        echo "## ðŸš€ Pipeline Execution Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Stage | Status | Duration |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|----------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ Python Tests | ${{ needs.python-tests.result }} | - |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ³ Docker Build | ${{ needs.docker-build.result }} | - |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ›¡ï¸ Security Scan | ${{ needs.security-scan.result }} | - |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸ“‹ Details:**" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY